<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Intern Inspection Checklist + Student Masterlist (Bulk Excel/CSV Import)</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --muted:#aeb8ff; --text:#e8ecff;
      --line:#27315e; --accent:#3551ff; --danger:#ff4d6d; --ok:#7CFFB5; --warn:#FFD27C; --bad:#FF7C9B;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, #18204a 0%, var(--bg) 55%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:5;
      padding:16px;
      border-bottom:1px solid var(--line);
      background: rgba(10,14,30,.65);
      backdrop-filter: blur(10px);
    }
    header h1{ margin:0; font-size:18px; }
    header p{ margin:6px 0 0; font-size:13px; color:#cfd6ff; }

    .wrap{ max-width: 1220px; margin:0 auto; padding:16px; }
    .grid{ display:grid; grid-template-columns: 1.25fr .75fr; gap:14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background: rgba(18,26,51,.92);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
    }
    .card .hd h2{ margin:0; font-size:14px; }
    .badge{ font-size:12px; color:var(--muted); }
    .card .bd{ padding:14px; }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:10px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(10,14,30,.25);
    }
    .tab{
      border:1px solid #2a3565;
      background:#0c1230;
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
      user-select:none;
    }
    .tab.active{ background: var(--accent); border-color: var(--accent); }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 560px){ .row{ grid-template-columns:1fr; } }

    label.small{ display:block; font-size:12px; color:#cfd6ff; margin-bottom:6px; }
    input, textarea, select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid #2a3565;
      background:#0c1230;
      color:var(--text);
      outline:none;
    }
    input:focus, textarea:focus, select:focus{
      border-color:#5063ff;
      box-shadow:0 0 0 3px rgba(80,99,255,.2);
    }
    textarea{ min-height:90px; resize:vertical; }

    .hint{
      margin:8px 0 0;
      font-size:12px;
      color:#cfd6ff;
      opacity:.95;
    }
    .hint code{
      background: rgba(10,14,30,.55);
      border:1px solid #2a3565;
      padding:2px 6px;
      border-radius:8px;
      color:#e8ecff;
    }

    .section{ margin-top:14px; }
    .section h3{ margin:0 0 10px; font-size:13px; color:#cfd6ff; }
    .items{ display:grid; gap:8px; }

    .item{
      display:flex; align-items:flex-start; gap:10px;
      padding:10px 10px;
      border:1px solid #24305c;
      background: rgba(10,15,35,.45);
      border-radius:14px;
    }
    .item input[type="checkbox"]{ width:18px; height:18px; margin-top:2px; }
    .item .txt{ flex:1; }
    .item .title{ margin:0; font-size:13px; }

    .ratingBox{
      margin-top:14px;
      display:grid; gap:10px;
      padding:12px;
      border:1px dashed #3b4a8f;
      border-radius:16px;
      background: rgba(10,14,30,.35);
    }
    .big{ font-size:36px; font-weight:900; margin:0; letter-spacing:.4px; }
    .sub{ margin:0; font-size:12px; color:#cfd6ff; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border:1px solid #2b3a73;
      border-radius:999px;
      background: rgba(10,14,30,.35);
      font-size:12px; color:#dbe0ff;
      width:fit-content;
    }
    .ok{ color:var(--ok); }
    .warn{ color:var(--warn); }
    .bad{ color:var(--bad); }

    .btns{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    button{
      border:1px solid #2a3565;
      background:#0c1230;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
    }
    button:hover{ border-color:#5063ff; }
    button.primary{ background: var(--accent); border-color: var(--accent); }
    button.primary:hover{ filter:brightness(1.05); }
    button.danger{ border-color: var(--danger); }
    button.danger:hover{ background: rgba(255,77,109,.08); }
    button.ghost{ background: transparent; }

    .tableWrap{ overflow:auto; border-radius:14px; border:1px solid var(--line); margin-top:10px; }
    table{ width:100%; border-collapse:collapse; min-width: 820px; background: rgba(10,14,30,.25); }
    th, td{ padding:10px 10px; border-bottom:1px solid #25305a; font-size:12px; text-align:left; vertical-align:top; }
    th{ position:sticky; top:0; z-index:2; background: rgba(18,26,51,.98); }
    .right{ text-align:right; }
    .tiny{ font-size:11px; color:#aeb8ff; }
    .actions{ display:flex; gap:8px; }
    .muted{ color:#bfc7ff; }

    .kpiRow{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
    }
    .kpi{
      border:1px solid #2b3a73;
      background: rgba(10,14,30,.35);
      padding:8px 10px;
      border-radius:14px;
      font-size:12px;
      color:#dbe0ff;
    }

    .twoCols{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 780px){ .twoCols{ grid-template-columns:1fr; } }
    .box{
      border:1px solid #24305c;
      background: rgba(10,15,35,.35);
      padding:12px;
      border-radius:14px;
    }

    .footnote{ margin-top:10px; font-size:12px; color:#cfd6ff; opacity:.9; }
  </style>
</head>
<body>
<header>
  <h1>Intern Inspection Checklist</h1>
  <p>Student masterlist supported: add manually OR bulk import from <b>Excel</b> (save as CSV). Records are stored on this device/browser.</p>
</header>

<div class="wrap">
  <div class="grid">

    <!-- LEFT: MAIN APP (Tabs: Inspection / Students) -->
    <div class="card">
      <div class="hd">
        <h2 id="leftTitle">Inspection Form</h2>
        <span class="badge" id="todayBadge"></span>
      </div>

      <div class="tabs">
        <div class="tab active" id="tabInspection">Inspection</div>
        <div class="tab" id="tabStudents">Students</div>
      </div>

      <div class="bd">

        <!-- ============== INSPECTION PANEL ============== -->
        <div id="panelInspection">
          <div class="twoCols">
            <div class="box">
              <label class="small">Select Student (from masterlist)</label>
              <select id="studentSelect">
                <option value="">— Select student —</option>
              </select>
              <p class="hint tiny">If you select a student, the Name and Student Code will auto-fill. You can still type manually.</p>
            </div>

            <div class="box">
              <div class="row">
                <div>
                  <label class="small">Date</label>
                  <input id="dateField" type="date" />
                </div>
                <div>
                  <label class="small">Inspector</label>
                  <input id="inspector" placeholder="Enter inspector name" />
                </div>
              </div>
              <div class="kpiRow">
                <div class="kpi">Items: <b id="kpiItems">17</b></div>
                <div class="kpi">Rating = (Passed ÷ Applicable) × 100</div>
                <div class="kpi">Storage: local (browser)</div>
              </div>
            </div>
          </div>

          <!-- REQUIRED FIELDS (as requested) -->
          <div class="row" style="margin-top:10px;">
            <div>
              <label class="small">Name of Intern</label>
              <input id="internName" placeholder="Enter full name" />
            </div>
            <div>
              <label class="small">Student Code / Student Number</label>
              <input id="studentCode" placeholder="Enter student code/number" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label class="small">Course/Section</label>
              <input id="courseSection" placeholder="e.g., BS Crim 3-A" />
            </div>
            <div>
              <label class="small">Quick Actions</label>
              <div class="btns" style="margin-top:0;">
                <button id="addStudentFromFormBtn">Add/Update Student to Masterlist</button>
                <button class="ghost" id="clearStudentSelectionBtn">Clear Selection</button>
              </div>
              <p class="hint tiny">“Add/Update” saves the Name + Student Code into your Students tab for future selection.</p>
            </div>
          </div>

          <!-- A -->
          <div class="section">
            <h3>A. Grooming and Personal Appearance</h3>
            <div class="items" id="secA"></div>
          </div>

          <!-- B -->
          <div class="section">
            <h3>B. Uniform Standards</h3>
            <div class="items" id="secB"></div>
          </div>

          <!-- C -->
          <div class="section">
            <h3>C. Required Materials and Identification</h3>
            <div class="items" id="secC"></div>
          </div>

          <!-- D -->
          <div class="section">
            <h3>D. Discipline and Compliance</h3>
            <div class="items" id="secD"></div>
          </div>

          <div class="section">
            <h3>Remarks (optional)</h3>
            <textarea id="remarks" placeholder="Deficiencies / corrections / notes..."></textarea>
          </div>

          <!-- RATING -->
          <div class="ratingBox">
            <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <p class="big" id="ratingPct">0%</p>
              <div>
                <div class="pill" id="countLine">0 / 17 items passed</div>
                <div class="tiny" id="naLine">N/A removed: 0</div>
              </div>
            </div>
            <p class="sub" id="verdictLine">Tip: If an item does not apply, mark it as N/A so it won’t reduce the rating.</p>

            <div class="btns">
              <button class="primary" id="saveRecordBtn">Save Inspection Record</button>
              <button id="resetInspectionBtn">Reset Inspection Form</button>
              <button id="exportInspectionsBtn">Export Inspections CSV</button>
              <button class="danger" id="clearInspectionsBtn">Clear All Inspection Records</button>
            </div>
          </div>

          <p class="footnote">
            <b>Inspection rating:</b> Each item is 1 point when applicable. Items marked <b>N/A</b> are excluded.
          </p>
        </div>

        <!-- ============== STUDENTS PANEL ============== -->
        <div id="panelStudents" style="display:none;">
          <div class="twoCols">
            <div class="box">
              <h3 style="margin:0 0 10px; font-size:13px; color:#cfd6ff;">Add Student (Manual)</h3>
              <div class="row">
                <div>
                  <label class="small">Student Code / Number</label>
                  <input id="stuCodeManual" placeholder="e.g., 2023-00123" />
                </div>
                <div>
                  <label class="small">Student Name</label>
                  <input id="stuNameManual" placeholder="e.g., Juan Dela Cruz" />
                </div>
              </div>
              <div class="btns">
                <button class="primary" id="addStudentManualBtn">Add/Update Student</button>
                <button id="clearStudentFormBtn">Clear</button>
              </div>
              <p class="hint">
                Manual add/update: if the <code>Student Code</code> already exists, the name will be updated.
              </p>
            </div>

            <div class="box">
              <h3 style="margin:0 0 10px; font-size:13px; color:#cfd6ff;">Bulk Import (Excel → CSV)</h3>

              <label class="small">1) Upload CSV file (recommended)</label>
              <input id="csvFileInput" type="file" accept=".csv,text/csv" />

              <div style="height:10px"></div>

              <label class="small">2) Or paste CSV text here</label>
              <textarea id="csvPaste" placeholder="StudentCode,StudentName
2023-0001,Juan Dela Cruz
2023-0002,Maria Santos"></textarea>

              <div class="btns">
                <button class="primary" id="importCsvBtn">Import / Merge</button>
                <button id="downloadTemplateBtn">Download CSV Template</button>
                <button id="exportStudentsBtn">Export Students CSV</button>
                <button class="danger" id="clearStudentsBtn">Clear Student Masterlist</button>
              </div>

              <p class="hint">
                Excel steps: Create two columns <code>StudentCode</code> and <code>StudentName</code> → File → Save As → <b>CSV (Comma delimited)</b> → import here.
              </p>
            </div>
          </div>

          <div class="box" style="margin-top:12px;">
            <div class="row">
              <div>
                <label class="small">Search students</label>
                <input id="studentSearch" placeholder="Search code or name..." />
              </div>
              <div>
                <label class="small">Students count</label>
                <input id="studentCount" disabled />
              </div>
            </div>

            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>Student Code / Number</th>
                    <th>Student Name</th>
                    <th class="right">Actions</th>
                  </tr>
                </thead>
                <tbody id="studentsTbody"></tbody>
              </table>
            </div>

            <p class="footnote tiny">
              Import mode is <b>Merge</b>: it adds new students and updates names for existing student codes.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: INSPECTION RECORDS -->
    <div class="card">
      <div class="hd">
        <h2>Inspection Records</h2>
        <span class="badge"><span id="recCount">0</span> record(s)</span>
      </div>
      <div class="bd">
        <label class="small">Search records</label>
        <input id="recordSearch" placeholder="Search by name / code / section / inspector / remarks..." />

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Intern</th>
                <th>Code</th>
                <th>Course/Section</th>
                <th>Inspector</th>
                <th class="right">Rating</th>
                <th class="right">Passed</th>
                <th class="right">Actions</th>
              </tr>
            </thead>
            <tbody id="recordsTbody"></tbody>
          </table>
        </div>

        <div class="btns">
          <button id="exportInspectionsBtn2">Export Inspections CSV</button>
        </div>

        <p class="footnote tiny">
          Tip: Always export CSV for backup.
        </p>
      </div>
    </div>

  </div>
</div>

<script>
  // ==================== CHECKLIST (exact items provided) ====================
  const checklist = {
    A: [
      { id:"haircut", title:"Proper haircut (clean and standard)" },
      { id:"shaven", title:"Clean-shaven appearance (for male interns)" },
      { id:"nails", title:"Clean and trimmed fingernails" },
      { id:"earrings", title:"Female interns: No dangling earrings" },
      { id:"hygiene", title:"Proper hygiene" },
      { id:"bearing", title:"Proper bearing and posture" }
    ],
    B: [
      { id:"ironed", title:"Properly ironed uniform (TYPE A)" },
      { id:"completeUniform", title:"Complete prescribed uniform" },
      { id:"nameplate", title:"Nameplate properly placed" },
      { id:"buckles", title:"Shined buckles and metal paraphernalia" },
      { id:"shoes", title:"Polished black shoes" },
      { id:"socks", title:"Black socks (plain, no designs)" }
    ],
    C: [
      { id:"handkerchief", title:"White handkerchief (clean and properly folded)" },
      { id:"tickler", title:"Tickler notebook" },
      { id:"ballpen", title:"Black ballpen (functional)" },
      { id:"schoolId", title:"Official School ID (visible and valid)" }
    ],
    D: [
      { id:"noAccessories", title:"No unauthorized accessories" },
      { id:"overallDiscipline", title:"Overall military bearing and discipline" }
    ]
  };
  const ALL_ITEMS = [...checklist.A, ...checklist.B, ...checklist.C, ...checklist.D];
  const TOTAL_ITEMS = ALL_ITEMS.length; // 17

  // ==================== STORAGE KEYS ====================
  const STORAGE_INSPECTIONS = "uv_ccje_inspections_v3";
  const STORAGE_STUDENTS = "uv_ccje_students_v3"; // student masterlist

  // ==================== STATE ====================
  const state = { checked:{}, applicable:{} };
  for (const item of ALL_ITEMS){
    state.checked[item.id] = true;
    state.applicable[item.id] = true;
  }

  // ==================== DOM HELPERS ====================
  const $ = (id) => document.getElementById(id);

  function escapeHTML(str){
    return (str ?? "").replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function formatDate(iso){
    if(!iso) return "";
    const [y,m,d] = iso.split("-").map(Number);
    const dt = new Date(y, m-1, d);
    return dt.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" });
  }

  // ==================== STUDENT MASTERLIST ====================
  // Student object: { code: "2023-0001", name: "Juan Dela Cruz" }
  function loadStudents(){
    try{
      const raw = localStorage.getItem(STORAGE_STUDENTS);
      return raw ? JSON.parse(raw) : [];
    } catch(e){
      console.warn("Students load error:", e);
      return [];
    }
  }
  function saveStudents(students){
    localStorage.setItem(STORAGE_STUDENTS, JSON.stringify(students));
  }

  function normalizeCode(code){
    return String(code ?? "").trim();
  }
  function normalizeName(name){
    return String(name ?? "").trim();
  }

  function upsertStudent(code, name){
    code = normalizeCode(code);
    name = normalizeName(name);
    if(!code || !name) return { ok:false, msg:"Student code and name are required." };

    const students = loadStudents();
    const idx = students.findIndex(s => String(s.code).toLowerCase() === code.toLowerCase());
    if(idx >= 0){
      students[idx].name = name; // update
    } else {
      students.push({ code, name });
    }
    // sort by code then name
    students.sort((a,b) => (a.code || "").localeCompare(b.code || "") || (a.name || "").localeCompare(b.name || ""));
    saveStudents(students);
    return { ok:true };
  }

  function deleteStudentByCode(code){
    const students = loadStudents();
    const next = students.filter(s => String(s.code).toLowerCase() !== String(code).toLowerCase());
    saveStudents(next);
  }

  function renderStudentSelect(){
    const sel = $("studentSelect");
    const students = loadStudents();
    const prev = sel.value;

    sel.innerHTML = `<option value="">— Select student —</option>`;
    for(const s of students){
      const opt = document.createElement("option");
      opt.value = s.code;
      opt.textContent = `${s.code} — ${s.name}`;
      sel.appendChild(opt);
    }

    // restore if exists
    if (students.some(s => s.code === prev)) sel.value = prev;
  }

  function renderStudentsTable(){
    const tbody = $("studentsTbody");
    const q = $("studentSearch").value.trim().toLowerCase();
    const students = loadStudents();

    $("studentCount").value = `${students.length} student(s)`;

    const filtered = !q ? students : students.filter(s => {
      const hay = `${s.code} ${s.name}`.toLowerCase();
      return hay.includes(q);
    });

    tbody.innerHTML = "";

    if(filtered.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="3" class="muted">No students found.</td>`;
      tbody.appendChild(tr);
      return;
    }

    for(const s of filtered){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHTML(s.code)}</b></td>
        <td>${escapeHTML(s.name)}</td>
        <td class="right">
          <div class="actions" style="justify-content:flex-end;">
            <button data-action="use" data-code="${escapeHTML(s.code)}">Use</button>
            <button class="danger" data-action="del" data-code="${escapeHTML(s.code)}">Delete</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  // When selecting student: fill into inspection fields
  $("studentSelect").addEventListener("change", () => {
    const code = $("studentSelect").value;
    if(!code) return;
    const students = loadStudents();
    const s = students.find(x => x.code === code);
    if(!s) return;
    $("internName").value = s.name;
    $("studentCode").value = s.code;
  });

  $("clearStudentSelectionBtn").addEventListener("click", () => {
    $("studentSelect").value = "";
    $("internName").value = "";
    $("studentCode").value = "";
  });

  // Add/update student based on form
  $("addStudentFromFormBtn").addEventListener("click", () => {
    const code = $("studentCode").value;
    const name = $("internName").value;
    const res = upsertStudent(code, name);
    if(!res.ok){ alert(res.msg); return; }
    renderStudentSelect();
    renderStudentsTable();
    alert("Student saved to masterlist ✅");
  });

  // Manual add/update student (Students tab)
  $("addStudentManualBtn").addEventListener("click", () => {
    const code = $("stuCodeManual").value;
    const name = $("stuNameManual").value;
    const res = upsertStudent(code, name);
    if(!res.ok){ alert(res.msg); return; }
    $("stuCodeManual").value = "";
    $("stuNameManual").value = "";
    renderStudentSelect();
    renderStudentsTable();
    alert("Student added/updated ✅");
  });

  $("clearStudentFormBtn").addEventListener("click", () => {
    $("stuCodeManual").value = "";
    $("stuNameManual").value = "";
  });

  $("studentSearch").addEventListener("input", renderStudentsTable);

  $("studentsTbody").addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if(!btn) return;
    const action = btn.dataset.action;
    const code = btn.dataset.code;

    if(action === "del"){
      if(!confirm(`Delete student ${code}?`)) return;
      deleteStudentByCode(code);
      renderStudentSelect();
      renderStudentsTable();
      return;
    }

    if(action === "use"){
      // jump to Inspection tab, select this student
      showTab("inspection");
      $("studentSelect").value = code;
      $("studentSelect").dispatchEvent(new Event("change"));
      return;
    }
  });

  // ==================== BULK IMPORT CSV ====================
  // Accepts CSV with header or no header:
  // StudentCode,StudentName
  // 2023-0001,Juan Dela Cruz
  function parseCsv(text){
    // Simple CSV parser with quote support
    const rows = [];
    let i = 0, field = "", row = [], inQuotes = false;

    while (i < text.length){
      const c = text[i];

      if (inQuotes){
        if (c === '"'){
          if (text[i+1] === '"'){ field += '"'; i += 2; continue; }
          inQuotes = false; i++; continue;
        } else {
          field += c; i++; continue;
        }
      } else {
        if (c === '"'){ inQuotes = true; i++; continue; }
        if (c === ','){
          row.push(field); field = ""; i++; continue;
        }
        if (c === '\r'){
          i++; continue;
        }
        if (c === '\n'){
          row.push(field); field = "";
          // ignore fully empty lines
          if (row.some(cell => String(cell).trim() !== "")) rows.push(row);
          row = [];
          i++; continue;
        }
        field += c; i++; continue;
      }
    }
    // last field
    row.push(field);
    if (row.some(cell => String(cell).trim() !== "")) rows.push(row);

    return rows;
  }

  function importStudentsFromCsvText(csvText){
    const rows = parseCsv(csvText || "");
    if(rows.length === 0) return { ok:false, msg:"CSV is empty." };

    // Detect header
    let startIdx = 0;
    const first = rows[0].map(x => String(x || "").trim().toLowerCase());
    const hasHeader = first.includes("studentcode") || first.includes("student_code") || first.includes("code")
                   || first.includes("studentname") || first.includes("student_name") || first.includes("name");
    if(hasHeader) startIdx = 1;

    let added = 0, updated = 0, skipped = 0;
    const existing = loadStudents();

    // Map existing by lower code
    const map = new Map(existing.map(s => [String(s.code).toLowerCase(), s]));

    for(let r = startIdx; r < rows.length; r++){
      const cols = rows[r];
      // Expect first two columns: code, name
      const code = normalizeCode(cols[0]);
      const name = normalizeName(cols[1]);

      if(!code || !name){ skipped++; continue; }

      const key = String(code).toLowerCase();
      if(map.has(key)){
        const obj = map.get(key);
        if(obj.name !== name){
          obj.name = name;
          updated++;
        } else {
          // no change, but count as skipped
          skipped++;
        }
      } else {
        const obj = { code, name };
        map.set(key, obj);
        added++;
      }
    }

    const merged = Array.from(map.values()).sort((a,b) => (a.code||"").localeCompare(b.code||"") || (a.name||"").localeCompare(b.name||""));
    saveStudents(merged);

    return { ok:true, added, updated, skipped, total: merged.length };
  }

  $("csvFileInput").addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if(!file) return;
    const text = await file.text();
    $("csvPaste").value = text;
  });

  $("importCsvBtn").addEventListener("click", () => {
    const text = $("csvPaste").value;
    const res = importStudentsFromCsvText(text);
    if(!res.ok){ alert(res.msg); return; }
    renderStudentSelect();
    renderStudentsTable();
    alert(`Import complete ✅\nAdded: ${res.added}\nUpdated: ${res.updated}\nSkipped: ${res.skipped}\nTotal Students: ${res.total}`);
  });

  $("downloadTemplateBtn").addEventListener("click", () => {
    const template = "StudentCode,StudentName\n2023-0001,Juan Dela Cruz\n2023-0002,Maria Santos\n";
    downloadTextFile(template, "student_masterlist_template.csv", "text/csv;charset=utf-8");
  });

  $("exportStudentsBtn").addEventListener("click", () => {
    const students = loadStudents();
    if(students.length === 0){ alert("No students to export."); return; }
    const headers = ["StudentCode","StudentName"];
    const rows = students.map(s => [s.code, s.name]);
    const csv = [headers, ...rows].map(line => line.map(csvCell).join(",")).join("\n");
    downloadTextFile(csv, `students_${todayISO()}.csv`, "text/csv;charset=utf-8");
  });

  $("clearStudentsBtn").addEventListener("click", () => {
    if(!confirm("This will delete the entire student masterlist from this browser. Continue?")) return;
    localStorage.removeItem(STORAGE_STUDENTS);
    renderStudentSelect();
    renderStudentsTable();
    alert("Student masterlist cleared.");
  });

  function csvCell(value){
    const s = String(value ?? "");
    const escaped = s.replace(/"/g,'""');
    if(/[",\n]/.test(escaped)) return `"${escaped}"`;
    return escaped;
  }
  function downloadTextFile(text, filename, mime){
    const blob = new Blob([text], {type: mime || "text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ==================== INSPECTIONS ====================
  function loadInspections(){
    try{
      const raw = localStorage.getItem(STORAGE_INSPECTIONS);
      return raw ? JSON.parse(raw) : [];
    } catch(e){
      console.warn("Inspections load error:", e);
      return [];
    }
  }
  function saveInspections(records){
    localStorage.setItem(STORAGE_INSPECTIONS, JSON.stringify(records));
  }

  function computeRating(){
    let applicableCount = 0, passedCount = 0, naCount = 0;
    for (const item of ALL_ITEMS){
      const app = !!state.applicable[item.id];
      if(!app){ naCount++; continue; }
      applicableCount++;
      if(state.checked[item.id]) passedCount++;
    }
    const pct = applicableCount === 0 ? 0 : (passedCount / applicableCount) * 100;
    return { pct, passedCount, applicableCount, naCount };
  }
  function verdictClass(pct){
    if (pct >= 90) return "ok";
    if (pct >= 80) return "warn";
    return "bad";
  }

  function buildSummary(){
    const passed = [], failed = [], na = [];
    for (const item of ALL_ITEMS){
      if(!state.applicable[item.id]) na.push(item.title);
      else if(state.checked[item.id]) passed.push(item.title);
      else failed.push(item.title);
    }
    return { passed, failed, na };
  }

  function currentInspectionPayload(){
    const { pct, passedCount, applicableCount, naCount } = computeRating();
    const pctRounded = Math.round(pct);

    return {
      id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "_" + Math.random().toString(16).slice(2)),
      dateISO: $("dateField").value || todayISO(),
      inspector: $("inspector").value.trim(),
      name: $("internName").value.trim(),
      studentCode: $("studentCode").value.trim(),
      courseSection: $("courseSection").value.trim(),
      pct: pctRounded,
      passedCount, applicableCount, naCount,
      remarks: $("remarks").value.trim(),
      checklist: { checked:{...state.checked}, applicable:{...state.applicable} },
      summary: buildSummary()
    };
  }

  function validateInspection(p){
    if(!p.name) return "Please enter the Name of Intern.";
    if(!p.studentCode) return "Please enter the Student Code / Student Number.";
    if(!p.courseSection) return "Please enter the Course/Section.";
    if(!p.dateISO) return "Please select a Date.";
    if(!p.inspector) return "Please enter the Inspector name.";
    if(p.applicableCount === 0) return "All items are marked N/A. Make at least one item applicable.";
    return null;
  }

  function renderRecords(){
    const tbody = $("recordsTbody");
    const q = $("recordSearch").value.trim().toLowerCase();
    const records = loadInspections();

    $("recCount").textContent = records.length;

    const filtered = !q ? records : records.filter(r => {
      const hay = `${r.dateISO} ${r.name} ${r.studentCode} ${r.courseSection} ${r.inspector} ${r.remarks}`.toLowerCase();
      return hay.includes(q);
    });

    tbody.innerHTML = "";

    if(filtered.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="8" class="muted">No records found.</td>`;
      tbody.appendChild(tr);
      return;
    }

    filtered.sort((a,b) => (b.dateISO + b.id).localeCompare(a.dateISO + a.id));

    for(const r of filtered){
      const tr = document.createElement("tr");
      const cls = verdictClass(r.pct);
      tr.innerHTML = `
        <td>${formatDate(r.dateISO)}</td>
        <td><b>${escapeHTML(r.name)}</b></td>
        <td>${escapeHTML(r.studentCode || "")}</td>
        <td>${escapeHTML(r.courseSection)}</td>
        <td>${escapeHTML(r.inspector)}</td>
        <td class="right"><b class="${cls}">${r.pct}%</b></td>
        <td class="right">${r.passedCount}/${r.applicableCount}</td>
        <td class="right">
          <div class="actions" style="justify-content:flex-end;">
            <button data-action="view" data-id="${r.id}">View</button>
            <button class="danger" data-action="del" data-id="${r.id}">Delete</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  $("recordSearch").addEventListener("input", renderRecords);

  $("recordsTbody").addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if(!btn) return;

    const action = btn.dataset.action;
    const id = btn.dataset.id;

    const records = loadInspections();
    const idx = records.findIndex(r => r.id === id);
    if(idx < 0) return;

    if(action === "del"){
      if(!confirm("Delete this inspection record?")) return;
      records.splice(idx, 1);
      saveInspections(records);
      renderRecords();
      return;
    }

    if(action === "view"){
      const r = records[idx];
      const failed = (r.summary?.failed || []).map(x => `✖ ${x}`).join("\n") || "(none)";
      const passed = (r.summary?.passed || []).map(x => `✔ ${x}`).join("\n") || "(none)";
      const na = (r.summary?.na || []).map(x => `N/A ${x}`).join("\n") || "(none)";
      alert(
`DATE: ${formatDate(r.dateISO)}
NAME OF INTERN: ${r.name}
STUDENT CODE: ${r.studentCode}
COURSE/SECTION: ${r.courseSection}
INSPECTOR: ${r.inspector}

RATING: ${r.pct}% (${r.passedCount}/${r.applicableCount} passed; N/A: ${r.naCount})

FAILED ITEMS:
${failed}

PASSED ITEMS:
${passed}

N/A ITEMS:
${na}

REMARKS:
${r.remarks || "(none)"}
`);
    }
  });

  function exportInspectionsCsv(){
    const records = loadInspections();
    if(records.length === 0){ alert("No inspection records to export."); return; }

    const headers = [
      "Date","Name of Intern","Student Code","Course/Section","Inspector",
      "Rating (%)","Passed","Applicable","N/A Count","Failed Items","Remarks"
    ];

    const rows = records
      .slice()
      .sort((a,b) => (a.dateISO + a.id).localeCompare(b.dateISO + b.id))
      .map(r => [
        r.dateISO,
        r.name,
        r.studentCode || "",
        r.courseSection,
        r.inspector,
        r.pct,
        r.passedCount,
        r.applicableCount,
        r.naCount,
        (r.summary?.failed || []).join(" | "),
        r.remarks || ""
      ]);

    const csv = [headers, ...rows].map(line => line.map(csvCell).join(",")).join("\n");
    downloadTextFile(csv, `inspections_${todayISO()}.csv`, "text/csv;charset=utf-8");
  }

  $("exportInspectionsBtn").addEventListener("click", exportInspectionsCsv);
  $("exportInspectionsBtn2").addEventListener("click", exportInspectionsCsv);

  $("clearInspectionsBtn").addEventListener("click", () => {
    if(!confirm("This will permanently delete ALL inspection records from this browser. Continue?")) return;
    localStorage.removeItem(STORAGE_INSPECTIONS);
    renderRecords();
    alert("All inspection records cleared.");
  });

  // ==================== CHECKLIST RENDER ====================
  function renderSection(containerId, items){
    const el = $(containerId);
    el.innerHTML = "";

    for(const item of items){
      const row = document.createElement("div");
      row.className = "item";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!state.checked[item.id];

      const txt = document.createElement("div");
      txt.className = "txt";
      txt.innerHTML = `<p class="title">${escapeHTML(item.title)}</p>`;

      const naWrap = document.createElement("div");
      naWrap.style.display = "flex";
      naWrap.style.flexDirection = "column";
      naWrap.style.alignItems = "center";
      naWrap.style.gap = "6px";

      const naLabel = document.createElement("span");
      naLabel.className = "tiny";
      naLabel.textContent = "N/A";

      const na = document.createElement("input");
      na.type = "checkbox";
      na.checked = !state.applicable[item.id];
      na.title = "Mark as Not Applicable";

      function syncDisabled(){
        const isNA = !state.applicable[item.id];
        cb.disabled = isNA;
        row.style.opacity = isNA ? 0.6 : 1;
      }
      syncDisabled();

      cb.addEventListener("change", () => {
        state.checked[item.id] = cb.checked;
        updateRatingUI();
      });

      na.addEventListener("change", () => {
        const isNA = na.checked;
        state.applicable[item.id] = !isNA;
        if(isNA) state.checked[item.id] = false;
        cb.checked = state.checked[item.id];
        syncDisabled();
        updateRatingUI();
      });

      naWrap.appendChild(naLabel);
      naWrap.appendChild(na);

      row.appendChild(cb);
      row.appendChild(txt);
      row.appendChild(naWrap);
      el.appendChild(row);
    }
  }

  function renderAllChecklist(){
    renderSection("secA", checklist.A);
    renderSection("secB", checklist.B);
    renderSection("secC", checklist.C);
    renderSection("secD", checklist.D);
    updateRatingUI();
  }

  function updateRatingUI(){
    const { pct, passedCount, applicableCount, naCount } = computeRating();
    const pctRounded = Math.round(pct);
    $("ratingPct").textContent = `${pctRounded}%`;
    $("ratingPct").className = `big ${verdictClass(pctRounded)}`;
    $("countLine").textContent = `${passedCount} / ${applicableCount} items passed`;
    $("naLine").textContent = `N/A removed: ${naCount}`;
  }

  // ==================== SAVE INSPECTION ====================
  $("saveRecordBtn").addEventListener("click", () => {
    const payload = currentInspectionPayload();
    const err = validateInspection(payload);
    if(err){ alert(err); return; }

    const records = loadInspections();
    records.push(payload);
    saveInspections(records);
    renderRecords();
    alert("Inspection record saved ✅");
  });

  $("resetInspectionBtn").addEventListener("click", () => {
    $("studentSelect").value = "";
    $("internName").value = "";
    $("studentCode").value = "";
    $("courseSection").value = "";
    $("inspector").value = "";
    $("remarks").value = "";
    $("dateField").value = todayISO();

    for (const item of ALL_ITEMS){
      state.checked[item.id] = true;
      state.applicable[item.id] = true;
    }
    renderAllChecklist();
  });

  // ==================== TABS ====================
  function showTab(which){
    const isInspection = which === "inspection";
    $("panelInspection").style.display = isInspection ? "" : "none";
    $("panelStudents").style.display = isInspection ? "none" : "";

    $("tabInspection").classList.toggle("active", isInspection);
    $("tabStudents").classList.toggle("active", !isInspection);

    $("leftTitle").textContent = isInspection ? "Inspection Form" : "Student Masterlist";
  }

  $("tabInspection").addEventListener("click", () => showTab("inspection"));
  $("tabStudents").addEventListener("click", () => showTab("students"));

  // ==================== INIT ====================
  $("dateField").value = todayISO();
  $("kpiItems").textContent = TOTAL_ITEMS;
  $("todayBadge").textContent = `Today: ${formatDate(todayISO())} • Items: ${TOTAL_ITEMS}`;
  renderAllChecklist();
  renderRecords();
  renderStudentSelect();
  renderStudentsTable();
</script>
</body>
</html>
